name: Update README with new PokÃ©mon team

on:
  schedule:
    - cron: '0 0 * * *' # Esto se ejecuta todos los dÃ­as a la medianoche UTC
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest changes
        run: git pull origin main

      - name: Update PokÃ©mon Team Image URLs
        run: |
          python - <<'PY'
          import random, re
          fn = "README.md"
          with open(fn, "r", encoding="utf-8") as f:
              s = f.read()

          def gen_imgs():
              return " ".join(
                  f'<img width="30%" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/{random.randint(1,1025)}.png" />'
                  for _ in range(6)
              )

          start = "<!-- POKEMON_TEAM_START -->"
          end = "<!-- POKEMON_TEAM_END -->"

          if start in s and end in s:
              imgs = gen_imgs()
              new_block = start + "\n" + imgs + "\n" + end
              s = re.sub(re.escape(start) + r".*?" + re.escape(end), new_block, s, flags=re.S)
              msg = "Replaced team between markers"
          else:
              # Fallback: replace the FIRST <img ... width="30%" ...> occurrence
              imgs = gen_imgs()
              new_s, n = re.subn(r'<img[^>]*width="30%"[^>]*>', imgs, s, count=1)
              if n:
                  s = new_s
                  msg = "Replaced first <img width=\"30%\" ...> as fallback"
              else:
                  # If nothing to replace, append markers + team at end
                  new_block = "\n" + start + "\n" + imgs + "\n" + end + "\n"
                  s = s + new_block
                  msg = "No marker or image found: appended team at EOF"

          with open(fn, "w", encoding="utf-8") as f:
              f.write(s)
          print(msg)
          PY

      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "feat(image):ðŸŒˆ New pokemon team"
            git push origin HEAD:${{ github.ref_name }}
          fi
